<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8" />
        <title>Contacts by Suffix</title>
        <style>
            body {
                font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                margin: 2rem;
                background: #f6f6f6;
            }

            h1 {
                margin-bottom: 1rem;
            }

            .controls {
                display: flex;
                align-items: center;
                gap: 1rem;
                margin-bottom: 1rem;
            }

            button {
                background: #0078ff;
                border: none;
                color: white;
                padding: 3px 10px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.9rem;
            }

            button:active {
                scale: 0.98;
            }

            #summary {
                margin: 0.5rem 0 1rem;
                font-size: 0.9rem;
                color: #555;
            }

            details {
                margin-bottom: 0.5rem;
                background: white;
                border-radius: 6px;
                padding: 0.5rem 0.75rem;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            summary {
                cursor: pointer;
                font-weight: 600;
            }

            ul {
                margin: 0.5rem 0 0.25rem 1.25rem;
                padding: 0;
                list-style: disc;
            }

            li {
                margin: 0.1rem 0;
                font-size: 0.9rem;
            }

            .badge {
                display: inline-block;
                background: #eee;
                border-radius: 999px;
                padding: 0.1rem 0.6rem;
                font-size: 0.8rem;
                margin-left: 0.5rem;
                color: #555;
            }

            .no-suffix {
                color: #b33;
            }

        </style>
    </head>

    <body>
        <h1>Contacts grouped by suffix</h1>

        <div class="controls">
            <input type="file" id="fileInput" accept=".vcf" />
            <button id="toggleSort">Sort by Count</button>
        </div>

        <div id="summary"></div>
        <div id="accordion"></div>

        <script>
            let cardsGlobal = [];
            let sortMode = "count";
            // other option: "alphabetical"

            document.getElementById("toggleSort").addEventListener("click", () => {
                sortMode = sortMode === "count" ? "alphabetical" : "count";
                renderAccordion(groupBySuffix(cardsGlobal), cardsGlobal.length);

                document.getElementById("toggleSort").textContent =
                    sortMode === "count" ? "Sort Alphabetically" : "Sort by Count";
            });

            document.getElementById("fileInput").addEventListener("change", async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const text = await file.text();
                cardsGlobal = parseVcf(text);

                renderAccordion(groupBySuffix(cardsGlobal), cardsGlobal.length);
            });

            function parseVcf (text) {
                const blocks = text
                    .split(/END:VCARD/i)
                    .map(b => b.trim())
                    .filter(b => /BEGIN:VCARD/i.test(b));

                const cards = [];

                for (const block of blocks) {
                    const fullBlock = block + "\nEND:VCARD\n";
                    const lines = fullBlock.split(/\r?\n/);

                    let name = "";
                    let suffix = "";

                    for (const line of lines) {
                        if (/^FN[:;]/i.test(line)) {
                            const fnValue = line.split(":").slice(1).join(":").trim();
                            name = fnValue || "(No Name)";
                        }

                        if (/^N[:;]/i.test(line)) {
                            const value = line.split(":").slice(1).join(":");
                            const parts = value.split(";");
                            if (parts.length >= 5) suffix = (parts[4] || "").trim();
                        }
                    }

                    cards.push({ name, suffix, raw: fullBlock });
                }

                return cards;
            }

            function groupBySuffix (cards) {
                const groups = new Map();

                for (const card of cards) {
                    const key = card.suffix || "No Suffix";
                    if (!groups.has(key)) groups.set(key, []);
                    groups.get(key).push(card);
                }

                let entries = Array.from(groups.entries());

                if (sortMode === "count") {
                    entries.sort((a, b) => {
                        const diff = b[1].length - a[1].length;
                        return diff !== 0 ? diff : a[0].localeCompare(b[0]);
                    });
                } else {
                    entries.sort((a, b) => a[0].localeCompare(b[0]));
                }

                return new Map(entries);
            }

            function renderAccordion (groups, totalCount) {
                const accordionEl = document.getElementById("accordion");
                accordionEl.innerHTML = "";

                const noSuffix = groups.get("No Suffix")?.length || 0;
                document.getElementById("summary").textContent =
                    `Total contacts: ${totalCount} · ` +
                    `Groups: ${groups.size} · ` +
                    `Without suffix: ${noSuffix}`;

                for (const [suffix, cards] of groups.entries()) {
                    const details = document.createElement("details");
                    const summary = document.createElement("summary");

                    summary.textContent = suffix;
                    const badge = document.createElement("span");
                    badge.className = "badge" + (suffix === "No Suffix" ? " no-suffix" : "");
                    badge.textContent = cards.length;
                    summary.appendChild(badge);

                    const list = document.createElement("ul");
                    const sorted = [...cards].sort((a, b) => a.name.localeCompare(b.name));

                    sorted.forEach(card => {
                        const li = document.createElement("li");
                        li.textContent = card.name;
                        list.appendChild(li);
                    });

                    details.appendChild(summary);
                    details.appendChild(list);
                    accordionEl.appendChild(details);
                }
            }
        </script>
    </body>

</html>
