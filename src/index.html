<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8" />
        <title>Contacts by Suffix</title>
        <style>
            body {
                font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                margin: 2rem;
                background: #f6f6f6;
            }

            h1 {
                margin-bottom: 1rem;
            }

            .controls {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                gap: 0.75rem;
                margin-bottom: 0.75rem;
            }

            input[type="file"] {
                font-size: 0.9rem;
            }

            #searchInput {
                flex: 1;
                min-width: 200px;
                padding: 0.4rem 0.6rem;
                border-radius: 6px;
                border: 1px solid #ccc;
                font-size: 0.9rem;
            }

            button {
                background: #0078ff;
                border: none;
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.9rem;
                white-space: nowrap;
            }

            button:active {
                scale: 0.98;
            }

            #summary {
                margin: 0.5rem 0 1rem;
                font-size: 0.9rem;
                color: #555;
            }

            details {
                margin-bottom: 0.5rem;
                background: white;
                border-radius: 6px;
                padding: 0.5rem 0.75rem;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            summary {
                cursor: pointer;
                font-weight: 600;
            }

            ul {
                margin: 0.5rem 0 0.25rem 1.25rem;
                padding: 0;
                list-style: disc;
            }

            li {
                margin: 0.1rem 0;
                font-size: 0.9rem;
            }

            .badge {
                display: inline-block;
                background: #eee;
                border-radius: 999px;
                padding: 0.1rem 0.6rem;
                font-size: 0.8rem;
                margin-left: 0.5rem;
                color: #555;
            }

            .no-suffix {
                color: #b33;
            }

            .muted {
                color: #777;
                font-size: 0.85rem;
            }

        </style>
    </head>

    <body>
        <h1>Contacts grouped by suffix</h1>

        <div class="controls">
            <input type="file" id="fileInput" accept=".vcf" />
            <input type="text" id="searchInput" placeholder="Search name, suffix, email, phone, etc." disabled />
            <button id="toggleSort" disabled>Sort by Count</button>
        </div>

        <div id="summary" class="muted">Load a .vcf file to begin.</div>
        <div id="accordion"></div>

        <script>
            let cardsGlobal = [];
            let sortMode = "count"; // "count" | "alphabetical"
            let searchQuery = "";

            const fileInput = document.getElementById("fileInput");
            const searchInput = document.getElementById("searchInput");
            const toggleSortBtn = document.getElementById("toggleSort");
            const summaryEl = document.getElementById("summary");
            const accordionEl = document.getElementById("accordion");

            fileInput.addEventListener("change", async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const text = await file.text();
                cardsGlobal = parseVcf(text);

                // Enable controls now that data exists
                searchInput.disabled = false;
                toggleSortBtn.disabled = false;

                searchQuery = "";
                searchInput.value = "";

                updateView();
            });

            toggleSortBtn.addEventListener("click", () => {
                sortMode = sortMode === "count" ? "alphabetical" : "count";
                toggleSortBtn.textContent =
                    sortMode === "count" ? "Sort Alphabetically" : "Sort by Count";
                updateView();
            });

            searchInput.addEventListener("input", (e) => {
                searchQuery = e.target.value.trim().toLowerCase();
                updateView();
            });

            function updateView () {
                if (!cardsGlobal.length) {
                    accordionEl.innerHTML = "";
                    summaryEl.textContent = "No contacts loaded.";
                    return;
                }

                const filtered = filterCards(cardsGlobal, searchQuery);
                const groups = groupBySuffix(filtered);

                renderAccordion(groups, cardsGlobal.length, filtered.length, searchQuery);
            }

            // --- Minimal VCF parser (FN + N suffix + raw) ---

            function parseVcf (text) {
                const blocks = text
                    .split(/END:VCARD/i)
                    .map((b) => b.trim())
                    .filter((b) => /BEGIN:VCARD/i.test(b));

                const cards = [];

                for (const block of blocks) {
                    const fullBlock = block + "\nEND:VCARD\n";
                    const lines = fullBlock.split(/\r?\n/);

                    let name = "";
                    let suffix = "";

                    for (const line of lines) {
                        // FN: full name
                        if (/^FN[:;]/i.test(line)) {
                            const fnValue = line.split(":").slice(1).join(":").trim();
                            name = fnValue || "(No Name)";
                        }

                        // N: Last;First;Middle;Prefix;Suffix
                        if (/^N[:;]/i.test(line)) {
                            const value = line.split(":").slice(1).join(":");
                            const parts = value.split(";");
                            if (parts.length >= 5) {
                                suffix = (parts[4] || "").trim();
                            }
                        }
                    }

                    cards.push({
                        name: name || "(No Name)",
                        suffix: suffix || "",
                        raw: fullBlock,
                        rawLower: fullBlock.toLowerCase(),
                    });
                }

                return cards;
            }

            // --- Filter by search query (name, suffix, any raw data) ---

            function filterCards (cards, query) {
                if (!query) return cards;

                return cards.filter((card) => {
                    const nameMatch = card.name.toLowerCase().includes(query);
                    const suffixMatch = (card.suffix || "").toLowerCase().includes(query);
                    const rawMatch = card.rawLower.includes(query); // matches email, phone, etc.

                    return nameMatch || suffixMatch || rawMatch;
                });
            }

            // --- Group by suffix and sort according to sortMode ---

            function groupBySuffix (cards) {
                const groups = new Map();

                for (const card of cards) {
                    const key = card.suffix || "No Suffix";
                    if (!groups.has(key)) groups.set(key, []);
                    groups.get(key).push(card);
                }

                let entries = Array.from(groups.entries());

                if (sortMode === "count") {
                    entries.sort((a, b) => {
                        const diff = b[1].length - a[1].length;
                        return diff !== 0 ? diff : a[0].localeCompare(b[0]);
                    });
                } else {
                    entries.sort((a, b) => a[0].localeCompare(b[0]));
                }

                return new Map(entries);
            }

            // --- Render accordions ---

            function renderAccordion (groups, totalCount, filteredCount, query) {
                accordionEl.innerHTML = "";

                const noSuffixCount = groups.get("No Suffix")?.length || 0;

                let summaryText =
                    `Total contacts: ${totalCount} 路 Showing: ${filteredCount} 路 ` +
                    `Groups: ${groups.size} 路 Without suffix (visible): ${noSuffixCount}`;

                if (query) {
                    summaryText += ` 路 Filter: "${query}"`;
                }

                summaryEl.textContent = summaryText;

                for (const [suffix, cards] of groups.entries()) {
                    const details = document.createElement("details");
                    const summary = document.createElement("summary");

                    summary.textContent = suffix;
                    const badge = document.createElement("span");
                    badge.className = "badge" + (suffix === "No Suffix" ? " no-suffix" : "");
                    badge.textContent = cards.length;
                    summary.appendChild(badge);

                    const list = document.createElement("ul");
                    const sortedCards = [...cards].sort((a, b) =>
                        a.name.localeCompare(b.name)
                    );

                    sortedCards.forEach((card) => {
                        const li = document.createElement("li");
                        li.textContent = card.name;
                        list.appendChild(li);
                    });

                    details.appendChild(summary);
                    details.appendChild(list);
                    accordionEl.appendChild(details);
                }
            }
        </script>
    </body>

</html>
